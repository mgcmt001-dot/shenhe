import os
import json
import streamlit as st
from openai import OpenAI

# ============ åŸºæœ¬é…ç½® ============

st.set_page_config(
    page_title="å°è¯´å»AIåŒ–ä¸é€»è¾‘æ¶¦è‰²åŠ©æ‰‹",
    page_icon="ğŸ“–",
    layout="wide",
)

st.title("ğŸ“– å°è¯´å»AIåŒ–ä¸é€»è¾‘æ¶¦è‰²åŠ©æ‰‹")
st.markdown(
    """
æœ¬å·¥å…·é¢å‘**å°è¯´ä½œè€…/æŠ•ç¨¿ä½œè€…**ï¼Œç”¨äºå¯¹åˆç¨¿ï¼ˆåŒ…æ‹¬ AI ç”Ÿæˆç¨¿ï¼‰è¿›è¡Œï¼š

- å»AIåŒ–æ¶¦è‰²ï¼šå¼±åŒ–å¸¸è§ AI ç—•è¿¹ï¼Œè®©è¯­è¨€æ›´è‡ªç„¶ã€æœ‰ä¸ªæ€§ï¼›
- é€»è¾‘ä¸è®¾å®šæ£€æŸ¥ï¼šäººç‰©åŠ¨æœºã€ä¸–ç•Œè§‚ã€è‡ªæ´½æ€§ç­‰é—®é¢˜æç¤ºã€‚

> è¯·è‡ªè¡Œç¡®è®¤æŠ•ç¨¿å¹³å°æ˜¯å¦å…è®¸ä½¿ç”¨ AI è¾…åŠ©åˆ›ä½œï¼Œå¹¶å¯¹æœ€ç»ˆç¨¿ä»¶è´Ÿè´£ã€‚
"""
)

# ============ OpenAI Client å·¥å…·å‡½æ•° ============

@st.cache_resource
def get_openai_client():
    """
    ä» Streamlit secrets æˆ–ç¯å¢ƒå˜é‡ä¸­è·å– OPENAI_API_KEYã€‚
    """
    api_key = None
    # ä¼˜å…ˆä» Streamlit secrets ä¸­å–
    if "OPENAI_API_KEY" in st.secrets:
        api_key = st.secrets["OPENAI_API_KEY"]
    # å…¶æ¬¡ä»ç¯å¢ƒå˜é‡ä¸­å–
    if not api_key:
        api_key = os.getenv("OPENAI_API_KEY")

    if not api_key:
        st.error(
            "æœªæ£€æµ‹åˆ° OPENAI_API_KEYã€‚\n\n"
            "è¯·åœ¨ï¼š\n"
            "1. Streamlit Cloud çš„ `Secrets` ä¸­æ·»åŠ  `OPENAI_API_KEY`ï¼Œæˆ–\n"
            "2. æœ¬åœ°è¿è¡Œæ—¶åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è®¾ç½® `OPENAI_API_KEY`ã€‚\n"
        )
        st.stop()

    client = OpenAI(api_key=api_key)
    return client


# ============ ä¾§è¾¹æ è®¾ç½® ============

with st.sidebar:
    st.header("âš™ è®¾ç½®")

    model = st.selectbox(
        "é€‰æ‹©æ¨¡å‹",
        options=["gpt-4.1-mini", "gpt-4.1"],
        index=0,
        help="gpt-4.1-miniï¼šä¾¿å®œã€å¤Ÿç”¨ï¼›gpt-4.1ï¼šæ›´å¼ºä½†æ›´è´µã€‚",
    )

    temperature = st.slider(
        "åˆ›é€ åŠ›ï¼ˆtemperatureï¼‰",
        min_value=0.0,
        max_value=1.2,
        value=0.5,
        step=0.1,
        help="æ•°å€¼è¶Šé«˜ï¼Œæ”¹å†™è¶Šå¤§èƒ†ã€è¶Šæœ‰åˆ›æ„ã€‚",
    )

    style_choice = st.selectbox(
        "é£æ ¼åå¥½",
        options=[
            "ä¿æŒåŸæ–‡é£æ ¼ä¸ºä¸»",
            "åå•†ä¸šæµè¡Œé£ï¼ˆé€‚åˆæ‚å¿—/å®ä½“å‡ºç‰ˆï¼‰",
            "æ–‡å­¦æ€§åå¼ºï¼ˆè¯­è¨€æ›´è®²ç©¶ï¼‰",
            "ç½‘æ–‡çˆ½æ–‡é£ï¼ˆèŠ‚å¥å¿«ã€çˆ½æ„Ÿå¼ºï¼‰",
        ],
        index=0,
    )

    st.markdown("---")

    do_humanize = st.checkbox(
        "è¿›è¡Œå»AIåŒ–æ¶¦è‰²", value=True,
        help="å‡å°‘æ¨¡æ¿åŒ–è¡¨è¾¾ã€ç©ºæ´é¸¡æ±¤å¥ã€è¿‡åº¦è§£é‡Šç­‰ AI ç—•è¿¹ã€‚"
    )
    do_logic = st.checkbox(
        "è¿›è¡Œé€»è¾‘ä¸ä¸–ç•Œè§‚æ£€æŸ¥", value=True,
        help="åŒ…æ‹¬äººç‰©åŠ¨æœºã€æ—¶é—´çº¿ã€è®¾å®šè‡ªæ´½ç­‰ã€‚"
    )

    target_use = st.selectbox(
        "ç¨¿ä»¶ä¸»è¦ç”¨é€”",
        options=["æ‚å¿—/å‡ºç‰ˆç¤¾æŠ•ç¨¿", "ç½‘æ–‡å¹³å°è¿è½½", "å¾æ–‡æ¯”èµ›", "ä¸ªäººç»ƒç¬”/è‡ªç”¨"],
        index=0,
    )

    st.markdown("---")
    st.caption("æç¤ºï¼šé•¿æ–‡å»ºè®®åˆ†ç« èŠ‚å¤„ç†ï¼Œå¯ä»¥æ›´ç»†è‡´ã€‚")


# ============ ä¸»åŒºåŸŸè¾“å…¥ ============

st.subheader("âœ ç²˜è´´ä½ çš„å°è¯´æ–‡æœ¬")

default_placeholder = (
    "åœ¨è¿™é‡Œç²˜è´´ä½ æƒ³è¦å¤„ç†çš„å°è¯´ç‰‡æ®µï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåœºæ™¯ã€ä¸€ç« æˆ–å‡ åƒå­—çš„éƒ¨åˆ†ã€‚\n\n"
    "å»ºè®®ï¼šä¸€æ¬¡å¤„ç† 2k~5k å­—å·¦å³ï¼Œæ–¹ä¾¿ç²¾ç»†ä¿®æ”¹å’Œæ£€æŸ¥ã€‚"
)

raw_text = st.text_area(
    "å°è¯´åŸæ–‡",
    value="",
    height=320,
    placeholder=default_placeholder,
)

st.subheader("ğŸŒ å¯é€‰ï¼šè¡¥å……è®¾å®š / å¤§çº²ä¿¡æ¯ï¼ˆæœ‰åŠ©äºé€»è¾‘æ£€æŸ¥ï¼‰")
extra_info = st.text_area(
    "ä¸–ç•Œè§‚ã€äººç‰©èƒŒæ™¯ã€å¤§çº²è¦ç‚¹ï¼ˆå¯é€‰ï¼‰",
    value="",
    height=150,
    placeholder="ä¾‹å¦‚ï¼š\n"
    "- æ•…äº‹å‘ç”Ÿåœ¨è¿‘æœªæ¥èµ›åšæœ‹å…‹åŸå¸‚ï¼›\n"
    "- ç”·ä¸»æ˜¯å§åº•è­¦å¯Ÿï¼Œè¡¨é¢å’Œé»‘å¸®æ˜¯æœ‹å‹ï¼›\n"
    "- å¥³ä¸»å‰æœŸä¸çŸ¥é“ç”·ä¸»èº«ä»½ï¼›\n"
    "- ç¬¬äºŒå·ä¸èƒ½å‡ºç°è¶…è‡ªç„¶å…ƒç´ ï¼›\n",
)

col1, col2 = st.columns([1, 2])
with col1:
    run_button = st.button("ğŸš€ å¼€å§‹åˆ†æä¸æ¶¦è‰²", type="primary")
with col2:
    char_count = len(raw_text)
    st.write(f"å½“å‰å­—æ•°ï¼ˆå«ç©ºæ ¼ï¼‰ï¼š**{char_count}** å­—å·¦å³")

    if char_count > 8000:
        st.warning("æ–‡æœ¬è¾ƒé•¿ï¼Œå¯èƒ½ä¼šç•¥å¾®å¢åŠ å¤„ç†æˆæœ¬ï¼Œå»ºè®®æŒ‰ç« èŠ‚åˆ†æ®µå¤„ç†ã€‚")


# ============ è°ƒç”¨ OpenAI å¹¶å±•ç¤ºç»“æœ ============

def build_user_prompt(
    text: str,
    extra: str,
    style_choice: str,
    do_humanize: bool,
    do_logic: bool,
    target_use: str,
) -> str:
    """
    å°†é¡µé¢ä¸Šçš„å‚æ•°æ•´ç†æˆä¸€ä¸ªæ¸…æ™°çš„ç”¨æˆ·æŒ‡ä»¤ã€‚
    """
    humanize_flag = "æ˜¯" if do_humanize else "å¦"
    logic_flag = "æ˜¯" if do_logic else "å¦"

    prompt = f"""
ä¸‹é¢æ˜¯ä½œè€…æä¾›çš„ä¸€æ®µå°è¯´æ–‡æœ¬ï¼Œè¯·ä½ ä½œä¸º**èµ„æ·±ä¸­æ–‡å°è¯´ç¼–è¾‘+å†™ä½œæ•™ç»ƒ**è¿›è¡Œä¸“ä¸šå¤„ç†ã€‚

ã€å¤„ç†ç›®æ ‡ã€‘ï¼š
1. åœ¨ä¸æ”¹å˜æ ¸å¿ƒæƒ…èŠ‚å’Œäººç‰©æ€§æ ¼çš„å¤§å‰æä¸‹ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œé€‚åº¦æ¶¦è‰²ã€‚
2. æ ¹æ®éœ€è¦ï¼Œå¼±åŒ–å¸¸è§ AI å†™ä½œç—•è¿¹ï¼Œè®©æ–‡å­—æ›´æœ‰â€œäººå‘³â€å’Œä¸ªäººé£æ ¼ã€‚
3. å¦‚å‹¾é€‰ï¼Œåˆ™æ£€æŸ¥é€»è¾‘å’Œä¸–ç•Œè§‚è‡ªæ´½æ€§ï¼ŒæŒ‡å‡ºå¯èƒ½çš„é—®é¢˜å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®ã€‚

ã€å‚æ•°è®¾ç½®ã€‘ï¼š
- å»AIåŒ–æ¶¦è‰²ï¼š{humanize_flag}
- é€»è¾‘/è®¾å®šæ£€æŸ¥ï¼š{logic_flag}
- é£æ ¼åå¥½ï¼š{style_choice}
- ç¨¿ä»¶ç”¨é€”ï¼š{target_use}

ã€å¦‚æœè¿›è¡Œäº†å»AIåŒ–æ¶¦è‰²ã€‘ï¼š
- ä¸è¦ä¸€å‘³åˆ å‡å­—æ•°ï¼Œå…è®¸é€‚å½“æ‰©å†™ç»†èŠ‚æˆ–å†…å¿ƒæˆï¼›
- é¿å…ï¼šå¥—è¯é¸¡æ±¤ã€è¿‡åº¦è§£é‡Šã€æ¯«æ— ä¸ªæ€§çš„â€œæ ‡å‡†ç­”æ¡ˆâ€å¥å¼ï¼›
- é¼“åŠ±ï¼šæœ‰ç‚¹æ£±è§’çš„è¡¨è¾¾ã€ç»†èŠ‚æå†™ã€ç¬¦åˆäººç‰©èº«ä»½çš„è¯­è¨€ï¼›
- ä¿æŒæ•´ä½“å™äº‹è§†è§’ã€äººç§°ã€æ—¶æ€çš„ä¸€è‡´æ€§ã€‚

ã€å¦‚æœè¿›è¡Œäº†é€»è¾‘/è®¾å®šæ£€æŸ¥ã€‘ï¼š
- ä¼˜å…ˆå…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š
  - äººç‰©è¡Œä¸ºå’Œå°è¯æ˜¯å¦ç¬¦åˆå…¶æ€§æ ¼å’Œå·²çŸ¥ä¿¡æ¯ï¼›
  - æ—¶é—´çº¿æ˜¯å¦åˆç†ï¼Œæœ‰æ²¡æœ‰â€œç¬é—´ç§»åŠ¨â€â€œå‰åçŸ›ç›¾â€ç­‰é—®é¢˜ï¼›
  - ä¸–ç•Œè§‚/è®¾å®šæœ‰æ²¡æœ‰è‡ªç›¸çŸ›ç›¾æˆ–çªç„¶æ”¹å˜ï¼›
  - ä¼ç¬”å’Œä¿¡æ¯é‡æ˜¯å¦åˆé€‚ï¼Œæ˜¯å¦å‡ºç°â€œä½œè€…çŸ¥é“ä½†è§’è‰²ä¸å¯èƒ½çŸ¥é“â€çš„æƒ…å†µã€‚
- è¯·ç”¨ç®€æ´æ˜äº†çš„æ¡ç›®è¯´æ˜é—®é¢˜ï¼Œå¹¶ç»™å‡ºå¯æ“ä½œçš„ä¿®æ”¹å»ºè®®ã€‚

ã€åŸæ–‡å°è¯´ç‰‡æ®µã€‘ï¼š
{text}

"""

    if extra.strip():
        prompt += f"""
ã€ä½œè€…è¡¥å……çš„ä¸–ç•Œè§‚/å¤§çº²ä¿¡æ¯ã€‘ï¼š
{extra}
"""
    prompt += """
ã€è¾“å‡ºæ ¼å¼ï¼ˆåŠ¡å¿…ä¸¥æ ¼è¿”å› JSONï¼‰ã€‘ï¼š
è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼Œé”®åŒ…æ‹¬ï¼š

- "edited_text": stringï¼Œç¼–è¾‘å’Œæ¶¦è‰²åçš„å®Œæ•´æ–‡æœ¬ï¼ˆå¦‚æœæ²¡æœ‰å‹¾é€‰å»AIåŒ–æ¶¦è‰²ï¼Œä¹Ÿè¯·å¯¹æ˜æ˜¾é”™åˆ«å­—/è¯­ç—…åšè½»å¾®ä¿®æ­£å³å¯ï¼‰ã€‚
- "ai_style_issues": array of stringï¼Œåˆ—å‡ºä½ è®¤ä¸ºåŸæ–‡ä¸­å¸¦æœ‰â€œAIå†™ä½œç—•è¿¹â€çš„é—®é¢˜ç‚¹ï¼ˆå¦‚æœæœªå‹¾é€‰å»AIåŒ–ï¼Œå¯å¡«ç©ºæ•°ç»„ï¼‰ã€‚
- "logic_issues": array of stringï¼Œåˆ—å‡ºé€»è¾‘ã€è®¾å®šã€è‡ªæ´½æ€§ç›¸å…³çš„é—®é¢˜å’Œç®€è¦è¯´æ˜ï¼ˆå¦‚æœæœªå‹¾é€‰é€»è¾‘æ£€æŸ¥ï¼Œå¯å¡«ç©ºæ•°ç»„ï¼‰ã€‚
- "suggestions": stringï¼Œä»â€œä½œä¸ºç¼–è¾‘ç»™ä½œè€…å†™åé¦ˆâ€çš„è§’åº¦ï¼Œç»™å‡ºæ•´ä½“å†™ä½œå»ºè®®ï¼ˆå¯ä»¥åŒ…æ‹¬èŠ‚å¥ã€äººç‰©å¡‘é€ ã€å™äº‹è§’åº¦ç­‰ï¼‰ã€‚

æ³¨æ„ï¼š
- åªè¾“å‡ºåˆæ³• JSONï¼Œä¸è¦åŒ…å« Markdown ä»£ç å—æ ‡è®°æˆ–å¤šä½™è¯´æ˜ã€‚
"""
    return prompt.strip()


if run_button:
    if not raw_text.strip():
        st.warning("è¯·å…ˆåœ¨ä¸Šæ–¹ç²˜è´´è¦å¤„ç†çš„å°è¯´æ–‡æœ¬ã€‚")
    else:
        client = get_openai_client()

        with st.spinner("æ­£åœ¨åˆ†æä¸æ¶¦è‰²æ–‡æœ¬ï¼Œè¯·ç¨å€™â€¦â€¦"):

            user_prompt = build_user_prompt(
                text=raw_text,
                extra=extra_info,
                style_choice=style_choice,
                do_humanize=do_humanize,
                do_logic=do_logic,
                target_use=target_use,
            )

            try:
                response = client.responses.create(
                    model=model,
                    input=[
                        {
                            "role": "system",
                            "content": (
                                "ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„ä¸­æ–‡å°è¯´ç¼–è¾‘å’Œå†™ä½œæ•™ç»ƒï¼Œ"
                                "æ“…é•¿å¸®åŠ©ä½œè€…å¯¹ç¨¿ä»¶è¿›è¡Œå»AIåŒ–ã€äººæ€§åŒ–æ¶¦è‰²ï¼Œå¹¶æŒ‡å‡ºé€»è¾‘ä¸è®¾å®šé—®é¢˜ã€‚"
                            ),
                        },
                        {
                            "role": "user",
                            "content": user_prompt,
                        },
                    ],
                    response_format={"type": "json_object"},
                    temperature=temperature,
                )

                # ä» Responses API ä¸­å–å‡ºæ–‡æœ¬ç»“æœ
                raw_output = response.output[0].content[0].text

                data = json.loads(raw_output)

            except Exception as e:
                st.error(f"è°ƒç”¨æ¨¡å‹æˆ–è§£æç»“æœæ—¶å‡ºé”™ï¼š{e}")
                st.code(str(e))
            else:
                edited_text = data.get("edited_text", "").strip()
                ai_issues = data.get("ai_style_issues", [])
                logic_issues = data.get("logic_issues", [])
                suggestions = data.get("suggestions", "").strip()

                st.markdown("---")
                st.subheader("âœ… ç¼–è¾‘åæ–‡æœ¬ï¼ˆå¯å†è‡ªè¡Œå¾®è°ƒï¼‰")
                st.text_area(
                    "ç¼–è¾‘åæ–‡æœ¬",
                    value=edited_text or "ï¼ˆæ¨¡å‹æœªè¿”å›ç¼–è¾‘åæ–‡æœ¬ï¼‰",
                    height=350,
                )

                col_a, col_b = st.columns(2)

                with col_a:
                    st.subheader("ğŸ” å¯èƒ½çš„ AI ç—•è¿¹")
                    if ai_issues:
                        for i, issue in enumerate(ai_issues, start=1):
                            st.markdown(f"**{i}.** {issue}")
                    else:
                        st.write("æœªè¿”å›æ˜æ˜¾çš„ AI ç—•è¿¹é—®é¢˜ï¼ˆæˆ–ä½ æœªå‹¾é€‰ç›¸å…³åŠŸèƒ½ï¼‰ã€‚")

                with col_b:
                    st.subheader("ğŸ§  é€»è¾‘ / è®¾å®šé—®é¢˜")
                    if logic_issues:
                        for i, issue in enumerate(logic_issues, start=1):
                            st.markdown(f"**{i}.** {issue}")
                    else:
                        st.write("æœªè¿”å›æ˜æ˜¾çš„é€»è¾‘æˆ–è®¾å®šé—®é¢˜ï¼ˆæˆ–ä½ æœªå‹¾é€‰ç›¸å…³åŠŸèƒ½ï¼‰ã€‚")

                st.subheader("âœ‰ ç¼–è¾‘ç»™ä½œè€…çš„æ€»è¯„å»ºè®®")
                st.write(suggestions or "ï¼ˆæ¨¡å‹æœªè¿”å›æ•´ä½“å»ºè®®ï¼‰")

                st.info(
                    "æç¤ºï¼šå»ºè®®ä½ åœ¨æ­¤åŸºç¡€ä¸Šå†è¿›è¡Œä¸€è½®äººå·¥ä¿®æ”¹ï¼Œé€æ®µæœ—è¯»ï¼Œ"
                    "æŠŠæ–‡å­—çœŸæ­£æ”¹æˆâ€œä½ çš„å£°éŸ³â€ï¼Œè¿™æ ·æŠ•ç¨¿é€šè¿‡ç‡å’Œç¼–è¾‘å¥½æ„Ÿåº¦éƒ½ä¼šæ›´é«˜ã€‚"
                )
else:
    st.caption("å‡†å¤‡å¥½æ–‡æœ¬åï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œåˆ†æä¸æ¶¦è‰²ã€‚")
